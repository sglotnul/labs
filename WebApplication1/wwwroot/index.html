<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        *{
            margin: 0;
            padding: 0;
        }
        body{
            color: white;
            display: flex;
        }
        navbar{
            position: fixed;
            height: 100px;
            width: 100%;
            top: 0;
            bottom: 0;
            background-color: black;
            font-size: 30px;
            padding: 30px;
            box-sizing: border-box;
        }
        container{
            height: 100%;
            padding: 100px 10px 0 10px;
        }
        container-item{
            display: block;
            padding: 6px;
            margin-top: 6px;
        }
        label{
            position: absolute;
            right: 6px;
            color: white;
            border-radius: 4px;
            padding: 3px 5px;
            max-height: 25px;
        }
        cart-bar{
            display: flex;
            float: right;
        }
        .cart-bar-label{
            margin-right: 6px;
        }
        .price-label{
            top: 6px;
            background-color: blue;
        }
        .add-to-cart-label{
            bottom: 6px;
            background-color: green;
            cursor: pointer;
        }
        a{
            text-decoration: none;
            color: white;
        }
        .category-item{
            text-align: center;
            background-color: gray;
        }
        .product-item{
            position: relative;
            color: black;
            border: solid black 2px;
            min-height: 55px;
        }
        .left{
            width: 30vw;
        }
        .right{
            width: 70vw;
        }
    </style>
</head>
<body>
    <script type="module">
        const quantityKey = "cartQuantity";
        const productKey = "product";
        
        function createTextElement(tag, text, className){
            let element = document.createElement(tag);
            element.innerHTML = text;
            element.className = className;
            
            return element;
        }
        
        async function tryGetData(url){
            let response = await fetch(url);

            if (response.ok) {
                return await response.json();
            } 
            
            console.log("Status code: " + response.status);
            
            return [];
        }
        
        function addToCart(product){
            let createProductKey = id => `${productKey}-${id}`;
            
            let existingProduct = JSON.parse(localStorage.getItem(createProductKey(product.id)));
            if (existingProduct) 
            {
                existingProduct.quantity++;
            }
            else{
                existingProduct = { ...product };
                existingProduct.quantity = 1;
            }

            localStorage.setItem(quantityKey, +localStorage.getItem(quantityKey) + 1 + '');
            
            localStorage.setItem(createProductKey(product.id), JSON.stringify(existingProduct));
            console.log(JSON.stringify(existingProduct));

            setCartQuantity();
        }

        function setCartQuantity(){
            let count = 0;
            let totalPrice = 0;
            
            for (let i = 0; i < localStorage.length; i++){
                let key = localStorage.key(i);
                if (!key.startsWith(productKey))
                    continue;
                
                let item = JSON.parse(localStorage.getItem(key));
                totalPrice += item.price * item.quantity;
                count += item.quantity;
            }
            
            let cartBar = document.querySelector("cart-bar");
            let span = createTextElement("span", `Your cart: ${count} items, ${(Math.round(totalPrice * 100) / 100).toFixed(2)} P`, "cart-bar-label");
            
            cartBar.innerHTML = "";
            cartBar.appendChild(span);
            cartBar.appendChild(createTextElement("button", "Checkout"));
        }
        
        async function main(){
            let responseData = await tryGetData("/all-categories");

            let container = document.getElementById("categories");
            for (let category of responseData){
                let element = createTextElement("container-item", category['name'], "category-item");
                
                let link = document.createElement("a");
                link.href = `?categoryId=${category["id"]}`;
                
                link.appendChild(element);
                
                container.appendChild(link);
            }

            responseData = await tryGetData("/products" + window.location.search);
            console.log(responseData);

            container = document.getElementById("products");
            for (let product of responseData){
                let element = document.createElement("container-item");
                element.className = "product-item"

                element.appendChild(createTextElement("h2", product.name));
                element.appendChild(createTextElement("h3", product.description));
                element.appendChild(createTextElement("label", (Math.round(product.price * 100) / 100).toFixed(2) + " ла", "price-label"));
                
                let addToCartButton = createTextElement("label", "Add to cart", "add-to-cart-label");
                addToCartButton.onclick = () => addToCart(product);
                
                element.appendChild(addToCartButton);

                container.appendChild(element);
            }
        }
        
        setCartQuantity();
        await main();
    </script>
    
    <navbar>
        <a href="/">SPORTS STORE</a>
        <cart-bar></cart-bar>
    </navbar>
    
    <container id="categories" class="left"></container>
    <container id="products" class="right"></container>
</body>
</html>